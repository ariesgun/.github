name: Sync template repositories
on:
  schedule:
    - cron: '0 0 14 * *'
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Path to a JSON configuration file'
        required: false
        default: '.github/sync-template-config.json'
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repositories: ${{ steps.config.outputs.repositories }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse repositories from configuration file
        id: config
        run: |
          CONFIG_FILE="${{ github.event.inputs.config_file || '.github/sync-template-config.json' }}"
          echo "Using configuration file: $CONFIG_FILE"
          
          if [ -f "$CONFIG_FILE" ]; then
          
            echo "$CONFIG_FILE"
            # Read and parse the configuration file
            TEMPLATE_REPO=$(jq -rc '.template_repository' "$CONFIG_FILE")
            REPOSITORIES=($(jq -rc '.repositories[]' "$CONFIG_FILE"))

            echo "${REPOSITORIES[@]}"
            
            LIST_REPOS=$(curl -s "https://api.github.com/users/ubiquity/repos")
            FILTERED_REPOS=$(echo $LIST_REPOS | jq -rc --arg TEMPLATE_REPO $TEMPLATE_REPO --arg $CUR_REPO ${{ github.repository }} '[.[] | select(.full_name != $TEMPLATE_REPO and .full_name != $CUR_REPO)]')
            ALL_REPOSITORIES=($(echo $FILTERED_REPOS | jq -rc '.[] | .full_name'))
            
            ALL_REPOSITORIES+=("${REPOSITORIES[@]}")
            echo ${{ github.repository }}
            echo ${ALL_REPOSITORIES[@]}

            LIST_REPOS=$(printf '"%s",' "${ALL_REPOSITORIES[@]}")
            LIST_REPOS="[${LIST_REPOS%,}]"

            # Set outputs
            echo "repositories=${LIST_REPOS}" >> $GITHUB_OUTPUT    
            echo "Configuration loaded successfully"
          fi
      - run: echo $JSON_STRING
        env:
          JSON_STRING: ${{ steps.config.outputs.repositories }}

  run-matrix:
    needs: prepare
    strategy:
      matrix: 
        repository: ${{ fromJson(needs.prepare.outputs.repositories) }}
      fail-fast: false
      max-parallel: 15
    uses: ./.github/workflows/sync-template.yml
    with:
      target_repository: ${{ matrix.repository }}
    secrets: inherit
